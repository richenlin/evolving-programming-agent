# 进化检查模块 (Evolution Check)

**重要**: 此模块必须在每个开发/修复循环结束后执行，是 programming-assistant 的强制后置步骤。

## 执行时机

- Full Mode: 开发循环完成后，git commit 之后
- Simple Mode: 修复循环完成后，git commit 之后
- 会话结束前（用户准备离开时）

## 检查流程

```
┌─────────────────────────────────────────────────────────┐
│                    进化检查入口                          │
└───────────────────────┬─────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│  Step 1: 检查进化模式状态                                │
│  检查 .opencode/.evolution_mode_active 是否存在          │
└───────────────────────┬─────────────────────────────────┘
                        │
            ┌───────────┴───────────┐
            │                       │
            ▼                       ▼
    ┌───────────────┐       ┌───────────────┐
    │ 进化模式激活   │       │ 进化模式未激活 │
    │ → 主动提取    │       │ → 被动检查    │
    └───────┬───────┘       └───────┬───────┘
            │                       │
            ▼                       ▼
    ┌───────────────┐       ┌───────────────────────────┐
    │ Step 2a:      │       │ Step 2b: 检查触发条件     │
    │ 运行触发检测   │       │ - 复杂问题(尝试>1次)?    │
    └───────┬───────┘       │ - 用户说"记住"?          │
            │               │ - 新最佳实践?            │
            │               └───────────┬───────────────┘
            │                           │
            │               ┌───────────┴───────────┐
            │               │                       │
            │               ▼                       ▼
            │       ┌───────────────┐       ┌───────────────┐
            │       │ 满足条件      │       │ 不满足条件    │
            │       │ → 执行提取    │       │ → 正常结束    │
            │       └───────┬───────┘       └───────────────┘
            │               │
            └───────┬───────┘
                    │
                    ▼
    ┌───────────────────────────────────────────────────┐
    │  Step 3: 执行经验提取                              │
    │  1. 运行 trigger_detector.py 分析会话             │
    │  2. 如果检测到有价值经验                          │
    │     → 调用 knowledge_summarizer.py 存储           │
    └───────────────────────────────────────────────────┘
```

## 触发条件

| 场景 | 触发 | 原因 |
|------|------|------|
| 修复问题失败2次后成功 | 是 | 复杂问题，值得记录 |
| 用户说"记住这个"、"以后都这样做" | 是 | 明确要求 |
| 发现更优解决方案 | 是 | 新最佳实践 |
| 特定环境的 workaround | 是 | 非标准方案 |
| 简单修改一行代码 | 否 | 价值低 |
| 用户说"很好"、"ok" | 否 | 无具体经验 |

## 执行命令

> **统一入口**: 所有命令通过 `run.py` 执行，自动检测环境和路径。

### Step 1: 检查进化模式状态

```bash
# 检查进化模式是否激活
python scripts/run.py mode --status
```

或直接检查文件：
```bash
# 检查标记文件
ls .opencode/.evolution_mode_active 2>/dev/null && echo "ACTIVE" || echo "INACTIVE"
```

### Step 2: 分析会话，检测触发条件

```python
# 使用 Task 工具异步执行触发检测
Task(
    subagent_type="general",
    description="Trigger detection",
    prompt="""
    分析当前会话，检测是否满足进化触发条件：
    
    执行: python scripts/run.py knowledge trigger --input "用户输入描述"
    
    检查以下内容：
    1. 本次会话的尝试次数（是否 > 1）
    2. 用户是否有明确的"记住"类反馈
    3. 是否发现了新的最佳实践
    4. 是否有非标准的 workaround
    
    返回结果：是否应该触发经验提取
    """
)
```

### Step 3: 执行经验提取和存储

```python
# 如果满足触发条件，执行知识归纳
Task(
    subagent_type="general",
    description="Knowledge summarization",
    prompt="""
    执行知识归纳并存储：
    
    执行: echo "{会话摘要}" | python scripts/run.py knowledge summarize --auto-store
    
    提取内容包括：
    - 问题描述
    - 解决方案
    - 关键洞察
    - 适用场景
    """
)
```

## 快速参考：存储命令

```bash
# 存储用户偏好
python scripts/run.py project store --preference "偏好内容"

# 存储修复方案
python scripts/run.py project store --fix "修复方案描述"

# 存储技术栈模式
python scripts/run.py project store --tech react --pattern "模式内容"

# 存储上下文触发器
python scripts/run.py project store --context when_testing --instruction "使用 Vitest"
```

## 示例场景

### 场景 1: 进化模式激活 + 复杂修复

```
用户: 帮我修复这个跨域问题
[尝试1: 修改 headers - 失败]
[尝试2: 配置 Vite proxy - 成功]

进化检查:
1. 检查 .evolution_mode_active → 存在
2. 检测到尝试次数 > 1 → 触发
3. 提取经验: "Vite 项目跨域问题需要配置 proxy"
4. 存储到知识库
```

### 场景 2: 进化模式未激活 + 用户明确要求

```
用户: 修复完成了，记住以后都用 pnpm
[修复成功，一次通过]

进化检查:
1. 检查 .evolution_mode_active → 不存在
2. 被动检查 → 用户说"记住" → 触发
3. 提取经验: "项目使用 pnpm 作为包管理器"
4. 存储到知识库
```

### 场景 3: 简单修复，无触发

```
用户: 帮我修复这个 typo
[修改一行代码，成功]

进化检查:
1. 检查 .evolution_mode_active → 不存在
2. 被动检查 → 尝试次数=1，无"记住"反馈 → 不触发
3. 正常结束
```

## 注意事项

1. **异步执行**: 经验提取应使用 Task 工具异步执行，不阻塞主交互
2. **静默模式**: 默认静默执行，只在存储成功后简短通知用户
3. **去重机制**: 知识库自动去重，无需担心重复存储
4. **最小干扰**: 不要因为进化检查影响用户体验
